# Publishing to HuggingFace Hub

Entrenar can publish trained models, model cards, and evaluation
results directly to HuggingFace Hub repositories. All types live in
`entrenar::hf_pipeline::publish`. This module is feature-gated
under `hub-publish`.

```toml
[dependencies]
entrenar = { version = "0.5", features = ["hub-publish"] }
```

## PublishConfig

Configuration for the target HuggingFace repository.

```rust,ignore
use entrenar::hf_pipeline::publish::{PublishConfig, RepoType};

let config = PublishConfig {
    repo_id: "my-org/whisper-finetuned".to_string(),
    repo_type: RepoType::Model,
    private: false,
    token: None,  // Resolved from HF_TOKEN env or ~/.cache/huggingface/token
    license: Some("apache-2.0".to_string()),
    tags: vec!["entrenar".to_string(), "asr".to_string()],
};
```

### RepoType

```rust,ignore
use entrenar::hf_pipeline::publish::RepoType;

// Three repository types, each with its own API path
assert_eq!(RepoType::Model.api_path(), "models");
assert_eq!(RepoType::Dataset.api_path(), "datasets");
assert_eq!(RepoType::Space.api_path(), "spaces");

// Default is Model
assert_eq!(RepoType::default(), RepoType::Model);
```

## HfPublisher

The publisher handles repository creation, file uploads, and model card generation via the HuggingFace REST API.

### Creating a Publisher

```rust,ignore
use entrenar::hf_pipeline::publish::{HfPublisher, PublishConfig};

let config = PublishConfig {
    repo_id: "my-org/my-model".to_string(),
    ..Default::default()
};

// Token is resolved automatically; fails with PublishError::AuthRequired if missing
let publisher = HfPublisher::new(config)?;
```

### Individual Operations

```rust,ignore
use std::path::Path;

// Create the repository (idempotent: 409 Conflict is treated as success)
let repo_url = publisher.create_repo()?;

// Upload a local file
publisher.upload_file(
    Path::new("output/model.safetensors"),
    "model.safetensors",
)?;

// Upload bytes directly (useful for generated content)
let config_json = serde_json::to_vec_pretty(&my_config)?;
publisher.upload_bytes(&config_json, "config.json")?;
```

### Full Publish Flow

The `publish` method chains create_repo, file uploads, and optional model card upload into a single call.

```rust,ignore
use std::path::Path;
use entrenar::hf_pipeline::publish::{HfPublisher, PublishConfig, ModelCard};

let publisher = HfPublisher::new(PublishConfig {
    repo_id: "my-org/my-model".to_string(),
    license: Some("mit".to_string()),
    ..Default::default()
})?;

let files: Vec<(&Path, &str)> = vec![
    (Path::new("output/model.safetensors"), "model.safetensors"),
    (Path::new("output/config.json"), "config.json"),
    (Path::new("output/tokenizer.json"), "tokenizer.json"),
];

let card = ModelCard {
    model_name: "my-model".to_string(),
    description: "Fine-tuned Whisper for medical transcription".to_string(),
    license: Some("mit".to_string()),
    language: vec!["en".to_string()],
    tags: vec!["asr".to_string(), "medical".to_string()],
    metrics: vec![("wer".to_string(), 0.042), ("rtfx".to_string(), 156.0)],
    training_details: Some("Fine-tuned on 500h medical audio.".to_string()),
    base_model: Some("openai/whisper-large-v3".to_string()),
};

let result = publisher.publish(&files, Some(&card))?;
println!("Published: {}", result.repo_url);
println!("Files uploaded: {}", result.files_uploaded);
println!("Model card: {}", result.model_card_generated);
```

## ModelCard Generation

`ModelCard` renders a HuggingFace-compatible `README.md` with YAML
front matter. The front matter encodes license, language, tags, base
model, and evaluation metrics in the `model-index` format.

```rust,ignore
use entrenar::hf_pipeline::publish::ModelCard;
use entrenar::eval::evaluator::{EvalResult, Metric};

// Build from an EvalResult
let mut result = EvalResult::new("my-model");
result.add_score(Metric::WER, 0.042);
result.add_score(Metric::BLEU, 0.85);

let card = ModelCard::from_eval_result(&result);
let markdown = card.to_markdown();
```

The generated markdown has this structure:

```yaml
---
tags:
- entrenar
model-index:
- name: my-model
  results:
  - metrics:
    - type: wer
      value: 0.042
    - type: bleu
      value: 0.85
---

# my-model

Model: my-model

## Evaluation Results

| Metric | Value |
|--------|-------|
| wer | 0.0420 |
| bleu | 0.8500 |

---
*Generated by [entrenar](https://github.com/paiml/entrenar)*
```

## JSONL Submission Formatting

For leaderboard submissions that require JSONL format, use the
`format_submission_jsonl` and `format_submissions_jsonl` functions.

```rust,ignore
use entrenar::hf_pipeline::publish::{format_submission_jsonl, format_submissions_jsonl};
use entrenar::eval::evaluator::{EvalResult, Metric};

let mut result = EvalResult::new("my-org/my-model");
result.add_score(Metric::PassAtK(1), 0.72);
result.add_score(Metric::PassAtK(10), 0.95);
result.inference_time_ms = 120.0;

let line = format_submission_jsonl(&result);
// {"model":"my-org/my-model","pass@1":0.72,"pass@10":0.95,"inference_time_ms":120.0}

// Batch formatting
let results = vec![result];
let jsonl = format_submissions_jsonl(&results);
```

Metric keys are mapped to leaderboard-compatible names: `wer`,
`bleu`, `rouge_1`, `perplexity`, `mmlu_accuracy`, `pass@k`,
`ndcg@k`.

## Error Handling

All publisher operations return `Result<_, PublishError>`:

| Variant | Cause |
|---------|-------|
| `AuthRequired` | No HF token found in config, env, or cache file |
| `InvalidRepoId` | `repo_id` is empty or missing the `owner/name` format |
| `RepoCreationFailed` | HF API rejected repo creation (permissions, quota) |
| `UploadFailed` | File upload HTTP error |
| `Http` | Network or client construction error |
| `Io` | Local file read error |
| `Serialization` | JSON serialization error |
